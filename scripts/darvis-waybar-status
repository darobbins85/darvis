#!/usr/bin/env python3
"""
Waybar custom module script for Darvis status.
Reads from FIFO pipe and outputs JSON for waybar consumption.

This script runs continuously and provides real-time status updates
to waybar's custom module. It reads JSON status updates from a FIFO pipe
and outputs them in the format expected by waybar.
When Darvis is not running, it shows a cleared status (empty).
"""

import sys
import os
import json
import time
from pathlib import Path

# User-specific FIFO path
FIFO_PATH = Path.home() / ".cache" / "darvis" / "status.fifo"

def main():
    """Main function to run the waybar status monitor."""

    # Default status when Darvis is not running or available
    initial_status = {
        "text": "",
        "class": "not-running",
        "tooltip": "Darvis: Not running"
    }

    # Output initial status
    print(json.dumps(initial_status), flush=True)
    current_status = initial_status.copy()

    try:
        # Ensure FIFO directory exists
        fifo_dir = FIFO_PATH.parent
        fifo_dir.mkdir(parents=True, exist_ok=True)

        while True:
            # Check if FIFO exists, if not create it
            if not FIFO_PATH.exists():
                os.mkfifo(FIFO_PATH)

            try:
                # Open FIFO for reading (blocking)
                with open(FIFO_PATH, 'r') as fifo:
                    # Darvis is running, update status to reflect that
                    running_status = {
                        "text": "ü§ñ",
                        "class": "running",
                        "tooltip": "Darvis: Running"
                    }
                    print(json.dumps(running_status), flush=True)

                    while True:
                        line = fifo.readline()
                        if line:
                            try:
                                # Parse JSON from FIFO
                                new_status = json.loads(line.strip())
                                current_status.update(new_status)
                                # Output to waybar
                                print(json.dumps(current_status), flush=True)
                            except json.JSONDecodeError as e:
                                # Invalid JSON, skip this line
                                print(f"Warning: Invalid JSON received: {line.strip()}", file=sys.stderr)
                                continue
                        else:
                            # No data available, small delay to prevent busy waiting
                            time.sleep(0.1)

            except (FileNotFoundError, OSError):
                # FIFO doesn't exist anymore, Darvis has exited
                # Update status to show Darvis is not running (back to initial/cleared state)
                print(json.dumps(initial_status), flush=True)
                
                # Wait for a while before checking again if Darvis restarts
                time.sleep(2)
                continue

            except KeyboardInterrupt:
                # Clean exit
                break

    except Exception as e:
        # If anything goes wrong, show error status
        error_status = {
            "text": "‚ùå",
            "class": "error",
            "tooltip": f"Darvis: Script error - {e}"
        }
        print(json.dumps(error_status), flush=True)

if __name__ == "__main__":
    main()